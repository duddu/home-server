daemon off;
worker_processes 1;
pid /var/run/nginx.pid;

events { worker_connections 256; }

http {
    server_tokens off;
    large_client_header_buffers 4 32k;
    access_log /var/log/nginx/nginx-reverse-proxy.log combined;

    upstream rust_api {
        server home-server:8000;
    }

    upstream router {
        server tplinkwifi.net;
    }

    upstream nginx_logs_websocket {
        server home-server:8888;
    }

    upstream rust_api_logs_websocket {
        server home-server:8889;
    }

    server {
        listen 8080 default_server;
        listen [::]:8080 default_server;
        listen 8443 ssl http2 default_server;
        listen [::]:8443 ssl http2 default_server;
        server_name _;

        ssl_reject_handshake on;

        return 401;
    }

    server {
        listen 8080;
        listen [::]:8080;
        server_name %DOMAIN_NAME%;

        return 301 https://$host$request_uri;
    }

    server {
        listen 8443 ssl http2;
        listen [::]:8443 ssl http2;
        server_name %DOMAIN_NAME%;

        ssl_certificate /usr/local/share/certs/server.pem-chain;
        ssl_certificate_key /usr/local/share/private/server.key;
        ssl_dhparam /usr/local/share/certs/dhparam.pem;

        ssl_client_certificate /usr/local/share/certs/ca.pem;
        ssl_verify_client on;

        ssl_prefer_server_ciphers on;
        ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK';

        location = /health {
            default_type text/plain;
            return 200 'OK';
        }

        location = /version {
            default_type application/json;
            return 200 '{"name":"home-server-nginx-reverse-proxy","version":"0.12.6"}';
        }

        location = /logs {
            proxy_pass         http://nginx_logs_websocket/;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection upgrade;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Host $server_name;
            proxy_pass_header  Server;
        }

        location ~ ^/(router|(webpages|cgi-bin))(/.+)?$ {
            rewrite            ^/router|(.+)$ /$1 break;
            proxy_pass         http://router;
            proxy_redirect     off;
            proxy_http_version 1.1;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_pass_header  Server;
        }

        location = /api/logs {
            proxy_pass         http://rust_api_logs_websocket/;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection upgrade;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Host $server_name;
            proxy_pass_header  Server;
        }

        location /api/ {
            proxy_pass         http://rust_api/;
            proxy_redirect     off;
            proxy_http_version 1.1;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Host $server_name;
            proxy_pass_header  Server;
            proxy_buffer_size           128k;
            proxy_buffers               4 256k;
            proxy_busy_buffers_size     256k;
        }
    }
}
