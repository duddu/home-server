name: Deploy Home Server
on:
  push:
    branches:
      - main
    paths:
      - '.git-crypt/**'
      - '.github/workflows/deploy-home-server.yml'
      - 'scripts/**'
      - '.gitattributes'
  workflow_call:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
env:
  SCRIPTS_PATH: https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/scripts
jobs:
  start-home-server-pod:
    name: Start Home Server pod
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2.3.1
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
      - name: Start home-server over SSH
        run:
          ssh ${{ secrets.SSH_USER }}@${{ secrets.DOMAIN_NAME }}
          "SSH_USER=${{ secrets.SSH_USER }} COMMIT_SHA=${{ github.sha }} bash <(curl -s ${{ env.SCRIPTS_PATH }}/home-server-deploy.sh)"
  e2e-health-check:
    name: Run e2e health check
    runs-on: ubuntu-latest
    needs: start-home-server-pod
    steps:
      - name: Prepare SSL client certificate
        run: echo "${{ secrets.SSL_CLIENT_CERTIFICATE }}" > ${{ runner.temp }}/client.pem
      - name: Execute health check script
        run:
          DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}
          SSL_CLIENT_CERT_PATH=${{ runner.temp }}/client.pem
          bash <(curl -s ${{ env.SCRIPTS_PATH }}/home-server-health-check.sh)